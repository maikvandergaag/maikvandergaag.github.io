<!doctype html>
<!--
  Minimal Mistakes Jekyll Theme 4.24.0 by Michael Rose
  Copyright 2013-2020 Michael Rose - mademistakes.com | @mmistakes
  Free for personal and commercial use under the MIT license
  https://github.com/mmistakes/minimal-mistakes/blob/master/LICENSE
-->
<html lang="en" class="no-js">
  <head>
    <meta charset="utf-8">

<!-- begin _includes/seo.html --><title>Kubernetes (AKS) attached to Azure Storage (Files) - Microsoft Playground</title>
<meta name="description" content="Kubernetes (AKS) can be used for many situations. For a client we needed to make files available trough a Kubernetes Pod. The files needed to be shared between containers, nodes and pods. To make these files available we used a file share that gave us a couple of advantages:  Files can be made read-only for a Pod. Files can be added via a Windows Network drive.  To prove the scenario worked we used a simple &quot;html&quot; file when we opened the external endpoint. &lt;html&gt; &lt;head&gt; &lt;/head&gt; &lt;body&gt; &lt;h1&gt;File Test&lt;/h1&gt; &lt;/body&gt; &lt;/html&gt; The container type we used within Kubernetes is &quot;httpd&quot; which is a container with a simple apache web server. (https://hub.docker.com/_/httpd/). Azure Storage Account For the file share we choose &quot;Azure Files&quot;. With Azure Files we can share a File Share with the Kubernetes Pods and Windows devices. For this you need to create an Azure Storage account.  Navigate to the Azure Portal (https://portal.azure.com). Click &quot;Create a resource&quot; and search for &quot;storage account&quot;. Choose &quot;Storage account - blob, file, table, queue&quot;. Fill in the correct properties and click on &quot;Create&quot;. When the storage account is created open the resource and click on &quot;Files&quot;.     In the Azure Files blade create a new &quot;File share&quot;.   With the Azure File Share created you can connect it to your windows machine.  Click on the file share in the Azure File blade.    Click on &quot;connect&quot;. In the connect blade it will present the PowerShell script that you can run on your environment to attach the file share.  $acctKey = ConvertTo-SecureString -String &quot;[key]&quot; -AsPlainText -Force $credential = New-Object System.Management.Automation.PSCredential -ArgumentList &quot;Azure\kubernetesstorage01&quot;, $acctKey New-PSDrive -Name Z -PSProvider FileSystem -Root &quot;[storage]&quot; -Credential $credential -Persist &quot;Note: Make sure you do not run this script as administrator. Running this script as administrator will add the drive but it will not show up in windows explorer for your account.&quot;  Kubernetes Secret For the authentication to the file share a secret entry needs to be made within Kubernetes. The secret will contain a couple of properties:  Storage account name Storage access key  Adding the secrets Kubernetes can be done via a yaml file or the kubectl command line. When using the yaml option encode the properties in base64. You can google for an online solution. I used: https://www.base64encode.net/ for example.  Command line kubectl create secret generic storage-secret --from-literal=azurestorageaccountname=[storage name] --from-literal=azurestorageaccountkey=[account key] Yaml apiVersion: v1 kind: Secret metadata:   name: storage-secret type: Opaque data:   azurestorageaccountname: [base64 account name]   azurestorageaccountkey: [base64 account key] The yaml will needs to be applied to Kubernetes by using the command: kubectl apply -f [filename] Kubernetes deployment For getting the container up and running we create a Kubernetes deployment that runs the container. apiVersion: apps/v1beta1 kind: Deployment metadata:   name: webfile spec:   replicas: 1   template:     metadata:       labels:         app: webfile     spec:       containers:       - name: webfile         image: httpd         imagePullPolicy: Always         volumeMounts:         - name: azurefileshare           mountPath: /usr/local/apache2/htdocs/           readOnly: true         ports:         - containerPort: 80       volumes:       - name: azurefileshare         azureFile:           secretName: storage-secret           shareName: storage           readOnly: false This deployment is a simple one that creates a single pod and attaches a volume to the mountPath: /usr/local/apache2/htdocs/  The mountPath is the starting point for the apache web server meaning that everything that is placed on the file share will be exposed by the pod. The deployment needs to be applied by using the following command: kubectl apply -f [kubernetes deployment file] Kubernetes service To get it externally available we have to take one more step. That step is configuring a Kubernetes service of the type &quot;LoadBalancer&quot;. apiVersion: v1 kind: Service metadata:   name: webfile spec:   type: LoadBalancer   ports:   - port: 80   selector:     app: webfile The service needs to be applied by using the command: kubectl apply -f [service deployment file] Applying the service should generate an external IP address. Checking if it is provisioned correctly you can look on the Kubernetes Dashboard:  Or by running the following kubectl command: kubectl get svc [service name]  Result Opening the IP in the browser will result in an empty page. Uploading the sample html file named &quot;index.html&quot; will have the expected result.  &nbsp; &nbsp;">


  <meta name="author" content="Maik van der Gaag">
  
  <meta property="article:author" content="Maik van der Gaag">
  


<meta property="og:type" content="article">
<meta property="og:locale" content="en_US">
<meta property="og:site_name" content="Microsoft Playground">
<meta property="og:title" content="Kubernetes (AKS) attached to Azure Storage (Files)">
<meta property="og:url" content="http://localhost:4000/2018/09/files-from-kubernetes-aks/">


  <meta property="og:description" content="Kubernetes (AKS) can be used for many situations. For a client we needed to make files available trough a Kubernetes Pod. The files needed to be shared between containers, nodes and pods. To make these files available we used a file share that gave us a couple of advantages:  Files can be made read-only for a Pod. Files can be added via a Windows Network drive.  To prove the scenario worked we used a simple &quot;html&quot; file when we opened the external endpoint. &lt;html&gt; &lt;head&gt; &lt;/head&gt; &lt;body&gt; &lt;h1&gt;File Test&lt;/h1&gt; &lt;/body&gt; &lt;/html&gt; The container type we used within Kubernetes is &quot;httpd&quot; which is a container with a simple apache web server. (https://hub.docker.com/_/httpd/). Azure Storage Account For the file share we choose &quot;Azure Files&quot;. With Azure Files we can share a File Share with the Kubernetes Pods and Windows devices. For this you need to create an Azure Storage account.  Navigate to the Azure Portal (https://portal.azure.com). Click &quot;Create a resource&quot; and search for &quot;storage account&quot;. Choose &quot;Storage account - blob, file, table, queue&quot;. Fill in the correct properties and click on &quot;Create&quot;. When the storage account is created open the resource and click on &quot;Files&quot;.     In the Azure Files blade create a new &quot;File share&quot;.   With the Azure File Share created you can connect it to your windows machine.  Click on the file share in the Azure File blade.    Click on &quot;connect&quot;. In the connect blade it will present the PowerShell script that you can run on your environment to attach the file share.  $acctKey = ConvertTo-SecureString -String &quot;[key]&quot; -AsPlainText -Force $credential = New-Object System.Management.Automation.PSCredential -ArgumentList &quot;Azure\kubernetesstorage01&quot;, $acctKey New-PSDrive -Name Z -PSProvider FileSystem -Root &quot;[storage]&quot; -Credential $credential -Persist &quot;Note: Make sure you do not run this script as administrator. Running this script as administrator will add the drive but it will not show up in windows explorer for your account.&quot;  Kubernetes Secret For the authentication to the file share a secret entry needs to be made within Kubernetes. The secret will contain a couple of properties:  Storage account name Storage access key  Adding the secrets Kubernetes can be done via a yaml file or the kubectl command line. When using the yaml option encode the properties in base64. You can google for an online solution. I used: https://www.base64encode.net/ for example.  Command line kubectl create secret generic storage-secret --from-literal=azurestorageaccountname=[storage name] --from-literal=azurestorageaccountkey=[account key] Yaml apiVersion: v1 kind: Secret metadata:   name: storage-secret type: Opaque data:   azurestorageaccountname: [base64 account name]   azurestorageaccountkey: [base64 account key] The yaml will needs to be applied to Kubernetes by using the command: kubectl apply -f [filename] Kubernetes deployment For getting the container up and running we create a Kubernetes deployment that runs the container. apiVersion: apps/v1beta1 kind: Deployment metadata:   name: webfile spec:   replicas: 1   template:     metadata:       labels:         app: webfile     spec:       containers:       - name: webfile         image: httpd         imagePullPolicy: Always         volumeMounts:         - name: azurefileshare           mountPath: /usr/local/apache2/htdocs/           readOnly: true         ports:         - containerPort: 80       volumes:       - name: azurefileshare         azureFile:           secretName: storage-secret           shareName: storage           readOnly: false This deployment is a simple one that creates a single pod and attaches a volume to the mountPath: /usr/local/apache2/htdocs/  The mountPath is the starting point for the apache web server meaning that everything that is placed on the file share will be exposed by the pod. The deployment needs to be applied by using the following command: kubectl apply -f [kubernetes deployment file] Kubernetes service To get it externally available we have to take one more step. That step is configuring a Kubernetes service of the type &quot;LoadBalancer&quot;. apiVersion: v1 kind: Service metadata:   name: webfile spec:   type: LoadBalancer   ports:   - port: 80   selector:     app: webfile The service needs to be applied by using the command: kubectl apply -f [service deployment file] Applying the service should generate an external IP address. Checking if it is provisioned correctly you can look on the Kubernetes Dashboard:  Or by running the following kubectl command: kubectl get svc [service name]  Result Opening the IP in the browser will result in an empty page. Uploading the sample html file named &quot;index.html&quot; will have the expected result.  &nbsp; &nbsp;">



  <meta property="og:image" content="http://localhost:4000/assets/profile/profile.png">



  <meta name="twitter:site" content="@maikvandergaag">
  <meta name="twitter:title" content="Kubernetes (AKS) attached to Azure Storage (Files)">
  <meta name="twitter:description" content="Kubernetes (AKS) can be used for many situations. For a client we needed to make files available trough a Kubernetes Pod. The files needed to be shared between containers, nodes and pods. To make these files available we used a file share that gave us a couple of advantages:  Files can be made read-only for a Pod. Files can be added via a Windows Network drive.  To prove the scenario worked we used a simple &quot;html&quot; file when we opened the external endpoint. &lt;html&gt; &lt;head&gt; &lt;/head&gt; &lt;body&gt; &lt;h1&gt;File Test&lt;/h1&gt; &lt;/body&gt; &lt;/html&gt; The container type we used within Kubernetes is &quot;httpd&quot; which is a container with a simple apache web server. (https://hub.docker.com/_/httpd/). Azure Storage Account For the file share we choose &quot;Azure Files&quot;. With Azure Files we can share a File Share with the Kubernetes Pods and Windows devices. For this you need to create an Azure Storage account.  Navigate to the Azure Portal (https://portal.azure.com). Click &quot;Create a resource&quot; and search for &quot;storage account&quot;. Choose &quot;Storage account - blob, file, table, queue&quot;. Fill in the correct properties and click on &quot;Create&quot;. When the storage account is created open the resource and click on &quot;Files&quot;.     In the Azure Files blade create a new &quot;File share&quot;.   With the Azure File Share created you can connect it to your windows machine.  Click on the file share in the Azure File blade.    Click on &quot;connect&quot;. In the connect blade it will present the PowerShell script that you can run on your environment to attach the file share.  $acctKey = ConvertTo-SecureString -String &quot;[key]&quot; -AsPlainText -Force $credential = New-Object System.Management.Automation.PSCredential -ArgumentList &quot;Azure\kubernetesstorage01&quot;, $acctKey New-PSDrive -Name Z -PSProvider FileSystem -Root &quot;[storage]&quot; -Credential $credential -Persist &quot;Note: Make sure you do not run this script as administrator. Running this script as administrator will add the drive but it will not show up in windows explorer for your account.&quot;  Kubernetes Secret For the authentication to the file share a secret entry needs to be made within Kubernetes. The secret will contain a couple of properties:  Storage account name Storage access key  Adding the secrets Kubernetes can be done via a yaml file or the kubectl command line. When using the yaml option encode the properties in base64. You can google for an online solution. I used: https://www.base64encode.net/ for example.  Command line kubectl create secret generic storage-secret --from-literal=azurestorageaccountname=[storage name] --from-literal=azurestorageaccountkey=[account key] Yaml apiVersion: v1 kind: Secret metadata:   name: storage-secret type: Opaque data:   azurestorageaccountname: [base64 account name]   azurestorageaccountkey: [base64 account key] The yaml will needs to be applied to Kubernetes by using the command: kubectl apply -f [filename] Kubernetes deployment For getting the container up and running we create a Kubernetes deployment that runs the container. apiVersion: apps/v1beta1 kind: Deployment metadata:   name: webfile spec:   replicas: 1   template:     metadata:       labels:         app: webfile     spec:       containers:       - name: webfile         image: httpd         imagePullPolicy: Always         volumeMounts:         - name: azurefileshare           mountPath: /usr/local/apache2/htdocs/           readOnly: true         ports:         - containerPort: 80       volumes:       - name: azurefileshare         azureFile:           secretName: storage-secret           shareName: storage           readOnly: false This deployment is a simple one that creates a single pod and attaches a volume to the mountPath: /usr/local/apache2/htdocs/  The mountPath is the starting point for the apache web server meaning that everything that is placed on the file share will be exposed by the pod. The deployment needs to be applied by using the following command: kubectl apply -f [kubernetes deployment file] Kubernetes service To get it externally available we have to take one more step. That step is configuring a Kubernetes service of the type &quot;LoadBalancer&quot;. apiVersion: v1 kind: Service metadata:   name: webfile spec:   type: LoadBalancer   ports:   - port: 80   selector:     app: webfile The service needs to be applied by using the command: kubectl apply -f [service deployment file] Applying the service should generate an external IP address. Checking if it is provisioned correctly you can look on the Kubernetes Dashboard:  Or by running the following kubectl command: kubectl get svc [service name]  Result Opening the IP in the browser will result in an empty page. Uploading the sample html file named &quot;index.html&quot; will have the expected result.  &nbsp; &nbsp;">
  <meta name="twitter:url" content="http://localhost:4000/2018/09/files-from-kubernetes-aks/">

  
    <meta name="twitter:card" content="summary">
    
      <meta name="twitter:image" content="http://localhost:4000/assets/profile/profile.png">
    
  

  



  <meta property="article:published_time" content="2018-09-11T11:50:15+02:00">






<link rel="canonical" href="http://localhost:4000/2018/09/files-from-kubernetes-aks/">




<script type="application/ld+json">
  {
    "@context": "https://schema.org",
    
      "@type": "Person",
      "name": "Maik van der Gaag",
      "url": "http://localhost:4000/",
      "sameAs": ["https://twitter.com/maikvandergaag","https://github.com/maikvandergaag"]
    
  }
</script>







<!-- end _includes/seo.html -->



  <link href="/feed.xml" type="application/atom+xml" rel="alternate" title="Microsoft Playground Feed">


<!-- https://t.co/dKP3o1e -->
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script>
  document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + ' js ';
</script>

<!-- For all browsers -->
<link rel="stylesheet" href="/assets/css/main.css">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5/css/all.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
<noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5/css/all.min.css"></noscript>



    <!-- start custom head snippets, customize with your own _includes/head-custom.html file -->

<link rel="stylesheet" href="/assets/css/custom.css">

<!-- You can set your favicon here -->
<link rel="icon" type="image/png" sizes="32x32" href="/favicon.png">
<meta name="msapplication-TileColor" content="#da532c">
<meta name="theme-color" content="#ffffff">

  </head>

  <body class="layout--single">
    <nav class="skip-links">
  <ul>
    <li><a href="#site-nav" class="screen-reader-shortcut">Skip to primary navigation</a></li>
    <li><a href="#main" class="screen-reader-shortcut">Skip to content</a></li>
    <li><a href="#footer" class="screen-reader-shortcut">Skip to footer</a></li>
  </ul>
</nav>

    <!--[if lt IE 9]>
<div class="notice--danger align-center" style="margin: 0;">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience.</div>
<![endif]-->

    

<div class="masthead">
  <div class="masthead__inner-wrap">
    <div class="masthead__menu">
      <nav id="site-nav" class="greedy-nav">
        
        <a class="site-title" href="/">
          Microsoft Playground
          <span class="site-subtitle">debug.write('Architecture, Azure, Azure DevOps, Git, GitHub, DevOps');</span>
        </a>
        <ul class="visible-links">
<li class="masthead__menu-item">
              <a href="/about">About</a>
            </li>
<li class="masthead__menu-item">
              <a href="/extensions">Extensions</a>
            </li>
<li class="masthead__menu-item">
              <a href="/speaking">Speaking</a>
            </li>
<li class="masthead__menu-item">
              <a href="/year-archive">Posts</a>
            </li>
<li class="masthead__menu-item">
              <a href="/categories">Categories</a>
            </li>
</ul>
        
        <button class="search__toggle" type="button">
          <span class="visually-hidden">Toggle search</span>
          <i class="fas fa-search"></i>
        </button>
        
        <button class="greedy-nav__toggle hidden" type="button">
          <span class="visually-hidden">Toggle menu</span>
          <div class="navicon"></div>
        </button>
        <ul class="hidden-links hidden"></ul>
      </nav>
    </div>
  </div>
</div>


    <div class="initial-content">
      



<div id="main" role="main">
  
  <div class="sidebar sticky">
  


<div itemscope itemtype="https://schema.org/Person">

  
    <div class="author__avatar">
      
        <img src="/assets/profile/profile.png" alt="Maik van der Gaag" itemprop="image">
      
    </div>
  

  <div class="author__content">
    
      <h3 class="author__name" itemprop="name">Maik van der Gaag</h3>
    
    
      <div class="author__bio" itemprop="description">
        <p>I am <strong>Microsoft Azure MVP</strong>, <strong>Speaker</strong> and <strong>Father</strong>.</p>

      </div>
    
  </div>

  <div class="author__urls-wrapper">
    <button class="btn btn--inverse">Follow</button>
    <ul class="author__urls social-icons">
      
        <li itemprop="homeLocation" itemscope itemtype="https://schema.org/Place">
          <i class="fas fa-fw fa-map-marker-alt" aria-hidden="true"></i> <span itemprop="name">Schiedam, The Netherlands</span>
        </li>
      

      
        
          
            <li><a href="https://twitter.com/maikvandergaag" rel="nofollow noopener noreferrer noopener noreferrer" target="_blank"><i class="fab fa-fw fa-twitter-square" aria-hidden="true"></i><span class="label">Twitter</span></a></li>
          
        
          
            <li><a href="https://github.com/maikvandergaag" rel="nofollow noopener noreferrer noopener noreferrer" target="_blank"><i class="fab fa-fw fa-github" aria-hidden="true"></i><span class="label">GitHub</span></a></li>
          
        
          
            <li><a href="https://www.linkedin.com/in/maikvandergaag/" rel="nofollow noopener noreferrer noopener noreferrer" target="_blank"><i class="fab fa-fw fa-linkedin" aria-hidden="true"></i><span class="label">Linkedin</span></a></li>
          
        
      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      <!--
  <li>
    <a href="http://link-to-whatever-social-network.com/user/" itemprop="sameAs" rel="nofollow noopener noreferrer">
      <i class="fas fa-fw" aria-hidden="true"></i> Custom Social Profile Link
    </a>
  </li>
-->
    </ul>
  </div>
</div>

  
  </div>



  <article class="page" itemscope itemtype="https://schema.org/CreativeWork">
    <meta itemprop="headline" content="Kubernetes (AKS) attached to Azure Storage (Files)">
    <meta itemprop="description" content='Kubernetes (AKS) can be used for many situations. For a client we needed to make files available trough a Kubernetes Pod. The files needed to be shared between containers, nodes and pods.To make these files available we used a file share that gave us a couple of advantages:Files can be made read-only for a Pod.Files can be added via a Windows Network drive.To prove the scenario worked we used a simple "html" file when we opened the external endpoint.&lt;html&gt;&lt;head&gt;&lt;/head&gt;&lt;body&gt;&lt;h1&gt;File Test&lt;/h1&gt;&lt;/body&gt;&lt;/html&gt;The container type we used within Kubernetes is "httpd" which is a container with a simple apache web server. (https://hub.docker.com/_/httpd/).Azure Storage AccountFor the file share we choose "Azure Files". With Azure Files we can share a File Share with the Kubernetes Pods and Windows devices. For this you need to create an Azure Storage account.Navigate to the Azure Portal (https://portal.azure.com).Click "Create a resource" and search for "storage account".Choose "Storage account - blob, file, table, queue".Fill in the correct properties and click on "Create".When the storage account is created open the resource and click on "Files". In the Azure Files blade create a new "File share".With the Azure File Share created you can connect it to your windows machine.Click on the file share in the Azure File blade.Click on "connect".In the connect blade it will present the PowerShell script that you can run on your environment to attach the file share.$acctKey = ConvertTo-SecureString -String "[key]" -AsPlainText -Force$credential = New-Object System.Management.Automation.PSCredential -ArgumentList "Azure\kubernetesstorage01", $acctKeyNew-PSDrive -Name Z -PSProvider FileSystem -Root "[storage]" -Credential $credential -Persist"Note: Make sure you do not run this script as administrator. Running this script as administrator will add the drive but it will not show up in windows explorer for your account."Kubernetes SecretFor the authentication to the file share a secret entry needs to be made within Kubernetes. The secret will contain a couple of properties:Storage account nameStorage access keyAdding the secrets Kubernetes can be done via a yaml file or the kubectl command line.When using the yaml option encode the properties in base64. You can google for an online solution. I used: https://www.base64encode.net/ for example. Command linekubectl create secret generic storage-secret --from-literal=azurestorageaccountname=[storage name] --from-literal=azurestorageaccountkey=[account key]YamlapiVersion: v1kind: Secretmetadata:  name: storage-secrettype: Opaquedata:  azurestorageaccountname: [base64 account name]  azurestorageaccountkey: [base64 account key]The yaml will needs to be applied to Kubernetes by using the command:kubectl apply -f [filename]Kubernetes deploymentFor getting the container up and running we create a Kubernetes deployment that runs the container.apiVersion: apps/v1beta1kind: Deploymentmetadata:  name: webfilespec:  replicas: 1  template:    metadata:      labels:        app: webfile    spec:      containers:      - name: webfile        image: httpd        imagePullPolicy: Always        volumeMounts:        - name: azurefileshare          mountPath: /usr/local/apache2/htdocs/          readOnly: true        ports:        - containerPort: 80      volumes:      - name: azurefileshare        azureFile:          secretName: storage-secret          shareName: storage          readOnly: falseThis deployment is a simple one that creates a single pod and attaches a volume to the mountPath: /usr/local/apache2/htdocs/ The mountPath is the starting point for the apache web server meaning that everything that is placed on the file share will be exposed by the pod.The deployment needs to be applied by using the following command:kubectl apply -f [kubernetes deployment file]Kubernetes serviceTo get it externally available we have to take one more step. That step is configuring a Kubernetes service of the type "LoadBalancer".apiVersion: v1kind: Servicemetadata:  name: webfilespec:  type: LoadBalancer  ports:  - port: 80  selector:    app: webfileThe service needs to be applied by using the command:kubectl apply -f [service deployment file]Applying the service should generate an external IP address. Checking if it is provisioned correctly you can look on the Kubernetes Dashboard:Or by running the following kubectl command:kubectl get svc [service name]ResultOpening the IP in the browser will result in an empty page. Uploading the sample html file named "index.html" will have the expected result.  '>
    <meta itemprop="datePublished" content="2018-09-11T11:50:15+02:00">
    

    <div class="page__inner-wrap">
      
        <header>
          <h1 id="page-title" class="page__title" itemprop="headline">Kubernetes (AKS) attached to Azure Storage (Files)
</h1>
          

  <p class="page__meta">
    

    

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-clock" aria-hidden="true"></i>
        
          4 minute read
        
      </span>
    
  </p>


        </header>
      

      <section class="page__content" itemprop="text">
        
        <p>Kubernetes (AKS) can be used for many situations. For a client we needed to make files available trough a Kubernetes Pod. The files needed to be shared between containers, nodes and pods.</p>
<p>To make these files available we used a file share that gave us a couple of advantages:</p>
<ul>
<li>Files can be made read-only for a Pod.</li>
<li>Files can be added via a Windows Network drive.</li>
</ul>
<p>To prove the scenario worked we used a simple "html" file when we opened the external endpoint.</p>
<pre class="highlight">&lt;html&gt;
&lt;head&gt;
&lt;/head&gt;
&lt;body&gt;
&lt;h1&gt;File Test&lt;/h1&gt;
&lt;/body&gt;
&lt;/html&gt;</pre>
<p>The container type we used within Kubernetes is "httpd" which is a container with a simple apache web server. (<a href="https://hub.docker.com/_/httpd/" target="_blank" rel="noopener noreferrer">https://hub.docker.com/_/httpd/</a>).</p>
<h2>Azure Storage Account</h2>
<p>For the file share we choose "Azure Files". With Azure Files we can share a File Share with the Kubernetes Pods and Windows devices. For this you need to create an Azure Storage account.</p>
<ol>
<li>Navigate to the Azure Portal (<a href="https://portal.azure.com" target="_blank" rel="noopener noreferrer">https://portal.azure.com</a>).</li>
<li>Click "Create a resource" and search for "storage account".</li>
<li>Choose "Storage account - blob, file, table, queue".</li>
<li>Fill in the correct properties and click on "Create".</li>
<li>When the storage account is created open the resource and click on "Files".</li>
</ol>
<p><a href="/assets/archive/2018/08/img-files.png"><img class="alignnone size-medium wp-image-3953" src="/assets/archive/2018/09/img-files-300x70.png" alt="Azure Files" width="300" height="70"></a></p>
<ol start="6">
<li> In the Azure Files blade create a new "File share".</li>
</ol>
<p><a href="/assets/archive/2018/08/img-fileshare.png"><img class="alignnone size-medium wp-image-3955" src="/assets/archive/2018/09/img-fileshare-300x48.png" alt="Azure File Share" width="300" height="48"></a></p>
<p>With the Azure File Share created you can connect it to your windows machine.</p>
<ol>
<li>Click on the file share in the Azure File blade.</li>
</ol>
<p><a href="/assets/archive/2018/08/img-connect.png"><img class="size-medium wp-image-3957 alignnone" src="/assets/archive/2018/09/img-connect-300x79.png" alt="Connect Azure File Share" width="300" height="79"></a></p>
<ol start="2">
<li>Click on "connect".</li>
<li>In the connect blade it will present the PowerShell script that you can run on your environment to attach the file share.</li>
</ol>
<pre class="highlight">$acctKey = ConvertTo-SecureString -String "[key]" -AsPlainText -Force
$credential = New-Object System.Management.Automation.PSCredential -ArgumentList "Azure\kubernetesstorage01", $acctKey
New-PSDrive -Name Z -PSProvider FileSystem -Root "[storage]" -Credential $credential -Persist</pre>
<p><em>"<strong>Note: </strong>Make sure you do not run this script as administrator. Running this script as administrator will add the drive but it will not show up in windows explorer for your account."</em></p>
<h2><a href="/assets/archive/2018/08/img-windowsexplorer.png"><img class="alignnone size-medium wp-image-3959" src="/assets/archive/2018/09/img-windowsexplorer-300x183.png" alt="Windows Explorer" width="300" height="183"></a></h2>
<h2>Kubernetes Secret</h2>
<p>For the authentication to the file share a secret entry needs to be made within Kubernetes. The secret will contain a couple of properties:</p>
<ul>
<li>Storage account name</li>
<li>Storage access key</li>
</ul>
<p>Adding the secrets Kubernetes can be done via a yaml file or the kubectl command line.</p>
<p><span style="display: inline !important; float: none; background-color: transparent; color: #111111; cursor: text; font-family: 'Arimo',Verdana,Arial; font-size: 15.2px; font-style: normal; font-variant: normal; font-weight: 400; letter-spacing: normal; orphans: 2; text-align: left; text-decoration: none; text-indent: 0px; text-transform: none; -webkit-text-stroke-width: 0px; white-space: normal; word-spacing: 0px;">When using the yaml option encode the properties in base64. You can google for an online solution. I used: </span><a href="https://www.base64encode.net/" target="_blank" rel="noopener noreferrer">https://www.base64encode.net/</a><span style="display: inline !important; float: none; background-color: transparent; color: #111111; cursor: text; font-family: 'Arimo',Verdana,Arial; font-size: 15.2px; font-style: normal; font-variant: normal; font-weight: 400; letter-spacing: normal; orphans: 2; text-align: left; text-decoration: none; text-indent: 0px; text-transform: none; -webkit-text-stroke-width: 0px; white-space: normal; word-spacing: 0px;"> for example. </span></p>
<p><strong>Command line</strong></p>
<pre class="highlight">kubectl create secret generic storage-secret --from-literal=azurestorageaccountname=[storage name] --from-literal=azurestorageaccountkey=[account key]</pre>
<p><strong>Yaml</strong></p>
<pre class="highlight">apiVersion: v1
kind: Secret
metadata:
  name: storage-secret
type: Opaque
data:
  azurestorageaccountname: [base64 account name]
  azurestorageaccountkey: [base64 account key]</pre>
<p>The yaml will needs to be applied to Kubernetes by using the command:</p>
<pre class="highlight">kubectl apply -f [filename]</pre>
<h2>Kubernetes deployment</h2>
<p>For getting the container up and running we create a Kubernetes deployment that runs the container.</p>
<pre class="highlight">apiVersion: apps/v1beta1
kind: Deployment
metadata:
  name: webfile
spec:
  replicas: 1
  template:
    metadata:
      labels:
        app: webfile
    spec:
      containers:
      - name: webfile
        image: httpd
        imagePullPolicy: Always
        volumeMounts:
        - name: azurefileshare
          mountPath: /usr/local/apache2/htdocs/
          readOnly: true
        ports:
        - containerPort: 80
      volumes:
      - name: azurefileshare
        azureFile:
          secretName: storage-secret
          shareName: storage
          readOnly: false</pre>
<p>This deployment is a simple one that creates a single pod and attaches a volume to the mountPath: <code class="EnlighterJSRAW" data-enlighter-language="shell">/usr/local/apache2/htdocs/ </code></p>
<p>The mountPath is the starting point for the apache web server meaning that everything that is placed on the file share will be exposed by the pod.</p>
<p><span style="display: inline !important; float: none; background-color: transparent; color: #111111; cursor: text; font-family: 'Arimo',Verdana,Arial; font-size: 15.2px; font-style: normal; font-variant: normal; font-weight: 400; letter-spacing: normal; orphans: 2; text-align: left; text-decoration: none; text-indent: 0px; text-transform: none; -webkit-text-stroke-width: 0px; white-space: normal; word-spacing: 0px;">The deployment needs to be applied by using the following command:</span></p>
<pre class="highlight">kubectl apply -f [kubernetes deployment file]</pre>
<h2>Kubernetes service</h2>
<p>To get it externally available we have to take one more step. That step is configuring a Kubernetes service of the type "LoadBalancer".</p>
<pre class="highlight">apiVersion: v1
kind: Service
metadata:
  name: webfile
spec:
  type: LoadBalancer
  ports:
  - port: 80
  selector:
    app: webfile</pre>
<p>The service needs to be applied by using the command:</p>
<pre class="highlight">kubectl apply -f [service deployment file]</pre>
<p>Applying the service should generate an external IP address. Checking if it is provisioned correctly you can look on the Kubernetes Dashboard:</p>
<p><a href="/assets/archive/2018/08/img-externalip.png"><img class="alignnone size-medium wp-image-3961" src="/assets/archive/2018/09/img-externalip-300x37.png" alt="External Endpoint" width="300" height="37"></a></p>
<p>Or by running the following kubectl command:</p>
<pre class="highlight">kubectl get svc [service name]</pre>
<p><a href="/assets/archive/2018/08/img-outputsvc.png"><img class="alignnone size-medium wp-image-3963" src="/assets/archive/2018/09/img-outputsvc-300x27.png" alt="Kubectl output svc" width="300" height="27"></a></p>
<h2>Result</h2>
<p>Opening the IP in the browser will result in an empty page. Uploading the sample html file named "index.html" will have the expected result.</p>
<p><a href="/assets/archive/2018/08/img-result.png"><img class="alignnone size-medium wp-image-3965" src="/assets/archive/2018/09/img-result-300x135.png" alt="Result" width="300" height="135"></a></p>
<p> </p>
<p> </p>

        
      </section>

      <footer class="page__meta">
        
        
  


  

  <p class="page__taxonomy">
    <strong><i class="fas fa-fw fa-tags" aria-hidden="true"></i> Tags: </strong>
    <span itemprop="keywords">
    
      <a href="/tags/#aks" class="page__taxonomy-item" rel="tag">AKS</a><span class="sep">, </span>
    
      <a href="/tags/#azure" class="page__taxonomy-item" rel="tag">Azure</a><span class="sep">, </span>
    
      <a href="/tags/#kubernetes" class="page__taxonomy-item" rel="tag">Kubernetes</a><span class="sep">, </span>
    
      <a href="/tags/#storage" class="page__taxonomy-item" rel="tag">Storage</a>
    
    </span>
  </p>




  


  

  <p class="page__taxonomy">
    <strong><i class="fas fa-fw fa-folder-open" aria-hidden="true"></i> Categories: </strong>
    <span itemprop="keywords">
    
      <a href="/categories/#azure" class="page__taxonomy-item" rel="tag">Azure</a>
    
    </span>
  </p>


        

  <p class="page__date"><strong><i class="fas fa-fw fa-calendar-alt" aria-hidden="true"></i> Updated:</strong> <time datetime="2018-09-11T11:50:15+02:00">September 11, 2018</time></p>


      </footer>

      <section class="page__share">
  

  <a href="https://twitter.com/intent/tweet?via=maikvandergaag&amp;text=Kubernetes+%28AKS%29+attached+to+Azure+Storage+%28Files%29%20http%3A%2F%2Flocalhost%3A4000%2F2018%2F09%2Ffiles-from-kubernetes-aks%2F" class="btn btn--twitter" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on Twitter" target="_blank" rel="noopener noreferrer"><i class="fab fa-fw fa-twitter" aria-hidden="true"></i><span> Twitter</span></a>

  <a href="https://www.facebook.com/sharer/sharer.php?u=http%3A%2F%2Flocalhost%3A4000%2F2018%2F09%2Ffiles-from-kubernetes-aks%2F" class="btn btn--facebook" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on Facebook" target="_blank" rel="noopener noreferrer"><i class="fab fa-fw fa-facebook" aria-hidden="true"></i><span> Facebook</span></a>

  <a href="https://www.linkedin.com/shareArticle?mini=true&amp;url=http%3A%2F%2Flocalhost%3A4000%2F2018%2F09%2Ffiles-from-kubernetes-aks%2F" class="btn btn--linkedin" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on LinkedIn" target="_blank" rel="noopener noreferrer"><i class="fab fa-fw fa-linkedin" aria-hidden="true"></i><span> LinkedIn</span></a>
</section>


      
  <nav class="pagination">
    
      <a href="/2018/08/local-kubernetes-cluster-with-dashboard/" class="pagination--pager" title="Local Kubernetes cluster with Dashboard
">Previous</a>
    
    
      <a href="/2018/09/aks-kubernetes-and-no-connection-could-be-made-because-the-target-machine-actively-refused-it/" class="pagination--pager" title="AKS (Kubernetes) and no connection could be made because the target machine actively refused it
">Next</a>
    
  </nav>

    </div>

    
  </article>

  
  
    <div class="page__related">
      <h4 class="page__related-title">You May Also Enjoy</h4>
      <div class="grid__wrapper">
        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/2023/05/creating-a-logic-app-api-connection-that-uses-the-managed-identity-using-bicep/" rel="permalink">Creating a Logic App API Connection that uses the Managed Identity using Bicep
</a>
      
    </h2>
    

  <p class="page__meta">
    

    

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-clock" aria-hidden="true"></i>
        
          2 minute read
        
      </span>
    
  </p>


    <p class="archive__item-excerpt" itemprop="description">Logic Apps in Azure provides a platform for building workflows that integrate with various services and APIs. When creating Logic Apps, you must often connec...</p>
  </article>
</div>

        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/2023/03/unlocking-the-power-of-azure-app-registrations-a-guide-to-exposing-your-app-as-an-api-with-user-assignments-required-turned-on/" rel="permalink">“Exposing Azure App Registrations as Secure APIs: A Guide to Authentication with ‘User Assignments Required’ Turned On”
</a>
      
    </h2>
    

  <p class="page__meta">
    

    

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-clock" aria-hidden="true"></i>
        
          3 minute read
        
      </span>
    
  </p>


    <p class="archive__item-excerpt" itemprop="description">Azure App Registrations are a powerful tool for managing resource access and integrating applications with Microsoft's cloud services. While these registrati...</p>
  </article>
</div>

        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/2022/12/centrally-manage-your-app-configurations/" rel="permalink">Centrally manage your App Configurations
</a>
      
    </h2>
    

  <p class="page__meta">
    

    

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-clock" aria-hidden="true"></i>
        
          10 minute read
        
      </span>
    
  </p>


    <p class="archive__item-excerpt" itemprop="description">The application landscape in Azure has grown significantly in recent years, with a wide range of tools and services available to help businesses build, deplo...</p>
  </article>
</div>

        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/2022/10/shift-left-security-with-microsoft-security-devops-msdo/" rel="permalink">Shift Left Security with Microsoft Security DevOps (MSDO)
</a>
      
    </h2>
    

  <p class="page__meta">
    

    

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-clock" aria-hidden="true"></i>
        
          3 minute read
        
      </span>
    
  </p>


    <p class="archive__item-excerpt" itemprop="description">With the new capabilities released add Ignite, you are now even more capable of shifting security checks further to the left. In this article, I explain how ...</p>
  </article>
</div>

        
      </div>
    </div>
  
  
</div>

    </div>

    
      <div class="search-content">
        <div class="search-content__inner-wrap">
<form class="search-content__form" onkeydown="return event.key != 'Enter';">
    <label class="sr-only" for="search">
      Enter your search term...
    </label>
    <input type="search" id="search" class="search-input" tabindex="-1" placeholder="Enter your search term...">
  </form>
  <div id="results" class="results"></div>
</div>

      </div>
    

    <div id="footer" class="page__footer">
      <footer>
        <script src="/assets/scripts/sidebarcontent.js"></script>
        <div class="page__footer-follow">
  <ul class="social-icons">
    

    
      
        
          <li><a href="https://twitter.com/maikvandergaag" rel="nofollow noopener noreferrer noopener noreferrer" target="_blank"><i class="fab fa-fw fa-twitter-square" aria-hidden="true"></i> Twitter</a></li>
        
      
        
          <li><a href="https://github.com/maikvandergaag" rel="nofollow noopener noreferrer noopener noreferrer" target="_blank"><i class="fab fa-fw fa-github" aria-hidden="true"></i> GitHub</a></li>
        
      
        
          <li><a href="https://www.linkedin.com/in/maikvandergaag/" rel="nofollow noopener noreferrer noopener noreferrer" target="_blank"><i class="fab fa-fw fa-linkedin" aria-hidden="true"></i> Linkedin</a></li>
        
      
    

    
      <li><a href="/feed.xml"><i class="fas fa-fw fa-rss-square" aria-hidden="true"></i> Feed</a></li>
    
  </ul>
</div>

<div class="page__footer-copyright">© 2023 Maik van der Gaag. Powered by <a href="https://jekyllrb.com" rel="nofollow noopener noreferrer" target="_blank">Jekyll</a> &amp; <a href="https://mademistakes.com/work/minimal-mistakes-jekyll-theme/" rel="nofollow noopener noreferrer" target="_blank">Minimal Mistakes</a>.</div>

      </footer>
    </div>

    
  <script src="/assets/js/main.min.js"></script>




<script src="/assets/js/lunr/lunr.min.js"></script>
<script src="/assets/js/lunr/lunr-store.js"></script>
<script src="/assets/js/lunr/lunr-en.js"></script>







  </body>
</html>
