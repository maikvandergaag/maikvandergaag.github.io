---
layout: post
title: Define Azure Resource Manager Policies
date: 2016-11-29 22:05:53.000000000 +01:00
type: post
parent_id: '0'
published: true
password: ''
status: publish
categories:
- Azure
tags:
- Azure
- Governance
- Policy
meta:
  yuzo_related_post_metabox: a:1:{s:21:"yuzo_disabled_related";N;}
  _edit_last: '1'
  _yoast_wpseo_focuskw_text_input: Azure Resource Manager Policies
  _yoast_wpseo_focuskw: Azure Resource Manager Policies
  _yoast_wpseo_linkdex: '77'
  _yoast_wpseo_content_score: '30'
  _yoast_wpseo_primary_category: ''
  snap_isAutoPosted: '1'
  _snap_forceSURL: '1'
  snap_MYURL: ''
  snapEdIT: '1'
  snapFB: s:412:"a:1:{i:0;a:13:{s:2:"do";s:1:"1";s:8:"postType";s:1:"A";s:10:"AttachPost";s:1:"2";s:10:"SNAPformat";s:51:"New
    post (%TITLE%) has been published on %SITENAME%";s:9:"isAutoImg";s:1:"A";s:8:"imgToUse";s:0:"";s:9:"isAutoURL";s:1:"A";s:8:"urlToUse";s:0:"";s:4:"doFB";s:1:"1";s:11:"isPrePosted";s:1:"1";s:8:"isPosted";s:1:"1";s:4:"pgID";s:33:"1428116197465709_1803113743299284";s:5:"pDate";s:19:"2016-11-29
    21:06:10";}}";
  snapTW: s:299:"a:1:{i:0;a:10:{s:2:"do";s:1:"1";s:10:"SNAPformat";s:25:"%TITLE% -
    %URL% - %HTAGS%";s:8:"attchImg";s:1:"0";s:9:"isAutoImg";s:1:"A";s:8:"imgToUse";s:0:"";s:4:"doTW";s:1:"1";s:11:"isPrePosted";s:1:"1";s:8:"isPosted";s:1:"1";s:4:"pgID";s:18:"803706648732860416";s:5:"pDate";s:19:"2016-11-29
    21:06:12";}}";
  _wpas_done_all: '1'
  snapLI: s:535:"a:1:{i:0;a:14:{s:2:"do";s:1:"1";s:8:"postType";s:1:"A";s:10:"SNAPformat";s:41:"New
    post has been published on %SITENAME%";s:12:"liMsgFormatT";s:18:"New Post - %TITLE%";s:9:"isAutoImg";s:1:"A";s:8:"imgToUse";s:0:"";s:9:"isAutoURL";s:1:"A";s:8:"urlToUse";s:0:"";s:4:"doLI";s:1:"1";s:11:"isPrePosted";s:1:"1";s:8:"isPosted";s:1:"1";s:4:"pgID";s:19:"6209474944884183040";s:7:"postURL";s:104:"https://www.linkedin.com/updates?discuss=&scope=22692038&stype=M&topic=6209474944884183040&type=U&a=O4UJ";s:5:"pDate";s:19:"2016-11-29
    21:16:33";}}";
  rop_post_url_twitter: https://msftplayground.com/2016/11/define-azure-resource-manager-policies/?utm_source=ReviveOldPost&utm_medium=social&utm_campaign=ReviveOldPost
  rop_post_url_facebook: https://msftplayground.com/2016/11/define-azure-resource-manager-policies/?utm_source=ReviveOldPost&utm_medium=social&utm_campaign=ReviveOldPost
  _oembed_b4acb7614547bffc4d48d9a200502a53: "{{unknown}}"
  medium_post: O:11:"Medium_Post":11:{s:16:"author_image_url";N;s:10:"author_url";N;s:11:"byline_name";N;s:12:"byline_email";N;s:10:"cross_link";N;s:2:"id";N;s:21:"follower_notification";N;s:7:"license";N;s:14:"publication_id";N;s:6:"status";N;s:3:"url";N;}
  _wds_opengraph: a:3:{s:5:"title";s:0:"";s:11:"description";s:0:"";s:6:"images";a:1:{i:0;s:0:"";}}
  _wds_twitter: a:3:{s:5:"title";s:0:"";s:11:"description";s:0:"";s:6:"images";a:1:{i:0;s:0:"";}}
  _wds_focus-keywords: Azure Resource Manager Policies
  _wds_title: ''
  _wds_metadesc: ''
  _wds_meta-robots-adv: ''
  _wds_meta-robots-nofollow: ''
  _wds_canonical: ''
author:
  login: maik@familie-vandergaag.nl
  email: maik@familie-vandergaag.nl
  display_name: Maik van der Gaag
  first_name: Maik
  last_name: van der Gaag
permalink: "/2016/11/define-azure-resource-manager-policies/"
---
<p>Azure Resource Manager policies provide you with the ability to manage risk within you Azure environment. You can write policies to enforce certain situations.</p>
<ul>
<li>A policy setting is default set to allow.</li>
<li>Policies are described by policy definitions in a policy definition language (if-then conditions).</li>
<li>You create polices with JSON formatted files.</li>
</ul>
<p>Policies that you have defined can be assigned to certain scopes:</p>
<ul>
<li>Subscription</li>
<li>Resource Group</li>
<li>Resource type</li>
</ul>
<p>Within the definition of the policies you can define the below actions:</p>
<ul>
<li><strong>Deny</strong>: Blocks the resource request</li>
<li><strong>Audit</strong>: Allows the request but adds a line to the activity log. These can be used to start action within Azure Automation.</li>
<li><strong>Append</strong>: Adds specified information to the resource. For example tagging the resource with useful information.</li>
</ul>
<p>I started to create Azure Resource Manager Policies and created a GitHub repository to save them and share them.</p>
<p>Within this repository you have the option to add policies and work together on them to get a default set of policies.</p>
<p>The repository also contains a script files to assign the policies to specific resources.</p>
<h2>Implementation</h2>
<p>One of the policies within the repository is a policy to ensure that resources are created within the Europe regions.</p>
<p>The policy is described in if-then conditions, if the resource is not created in West-Europe (westeurope) or North-Europe (northeurope) the creation of the resource will be declined (deny).</p>
<pre class="brush: js;">{
    "$schema": "http://schema.management.azure.com/schemas/2015-10-01-preview/policyDefinition.json",
    "if": {
        "not": {
            "field": "location",
            "in" : ["northeurope" , "westeurope"]
        }
    },
    "then": {
     "effect": "deny"   
    }
}
</pre>
<p>In the policy file the schema file specified to get type-ahead functionality within JSON editors.</p>
<p>This policy can be assigned to a resource with executing two PowerShell commands:</p>
<ol>
<li>New-AzureRmPolicyDefinition</li>
<li>New-AzureRmPolicyAssignment</li>
</ol>
<p>With the first command the definition is created, and saved to a PowerShell object.</p>
<pre class="brush: powershell;">$policy = New-AzureRmPolicyDefinition -Name [Policy Name] -Description [Policy Description] -Policy [Path to Policy JSON File]
</pre>
<p>The second command is then used to assign the policy to a certain scope.</p>
<pre class="brush: powershell;">New-AzureRmPolicyAssignment -Name [Policy Name] -PolicyDefinition $policy -Scope [Scope]
</pre>
<p>Putting everything together and making the script as generic as possible you have the following script to assign a policy to a resource group.</p>
<pre class="brush: powershell;">$policyName = Read-Host "Specify the name of the policy";
$policyDescription = Read-Host "Specify the description of the policy"
$policyFile = Read-Host "Path to json policy file";
$resourceGroup = Read-Host "Specify the resource group";

#Login to the Azure Resource Management Account
Login-AzureRmAccount

#Let the user choose the right subscrition
Write-Host "---------------------------------------------------------------------"
Write-Host "Your current subscriptions: " -ForegroundColor Yellow
Get-AzureRMSubscription
Write-Host "Enter the Subscription ID to deploy to: " -ForegroundColor Green
$sub = Read-Host 
Set-AzureRmContext -SubscriptionId $sub
clear

$subId = (Get-AzureRmContext).Subscription.SubscriptionId
$subName = (Get-AzureRmContext).Subscription.SubscriptionName

Write-Host "Policy is applied to the resource group: $resourceGroup in subscription: $subName"
$policy = New-AzureRmPolicyDefinition -Name $policyName -Description $policyDescription -Policy $policyFile;

#Assign the Azure Policy
New-AzureRmPolicyAssignment -Name $policyName -PolicyDefinition $policy -Scope "/subscriptions/$sub/resourceGroups/$resourcegroup"
</pre>
<p>After assigning the policy and trying to create a resource in another region will result in a error message. Sometimes this can still be a really descriptive message as shown in the image below.</p>
<p><a href="https://msftplayground.com/wp-content/uploads/2016/11/image-13.png"><img style="background-image: none; padding-top: 0px; padding-left: 0px; display: inline; padding-right: 0px; border: 0px;" title="Policy Message" src="{{ site.baseurl }}/assets/archive/2016/11/image_thumb-13.png" alt="Policy Message" width="434" height="356" border="0" /></a></p>
<h2></h2>
<h2>GitHub</h2>
<p>Check out the GitHub for the script files and the policies and when you have policy definitions share them:</p>
<p><a href="https://github.com/MaikvanderGaag/MSFT-Azure-Policy" target="_blank">https://github.com/MaikvanderGaag/MSFT-Azure-Policy</a></p>
