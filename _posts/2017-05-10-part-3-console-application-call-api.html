---
layout: post
title: Part 3 &ndash; Console application to call a API with Azure Active Directory
  Authentication
date: 2017-05-10 08:25:27.000000000 +02:00
type: post
parent_id: '0'
published: true
password: ''
status: publish
categories:
- Development
tags:
- API
- Azure App Services
- Azure SQL Server
- Identity
meta:
  yuzo_related_post_metabox: a:1:{s:21:"yuzo_disabled_related";N;}
  _edit_last: '1'
  _yoast_wpseo_content_score: '30'
  _yoast_wpseo_primary_category: ''
  _thumbnail_id: '3095'
  _yoast_wpseo_focuskw_text_input: API
  _yoast_wpseo_focuskw: API
  _yoast_wpseo_linkdex: '79'
  _oembed_fea149bcc28ffe0e8401d9c78374f8d3: "{{unknown}}"
  snap_isAutoPosted: '1'
  _wpas_done_all: '1'
  _oembed_b7280214b74283d7a73b39f5e5331d80: "{{unknown}}"
  _snap_forceSURL: '1'
  snap_MYURL: ''
  snapEdIT: '1'
  snapFB: s:421:"a:1:{i:0;a:11:{s:2:"do";s:1:"1";s:9:"msgFormat";s:51:"New post (%TITLE%)
    has been published on %SITENAME%";s:8:"postType";s:1:"A";s:9:"isAutoImg";s:1:"A";s:8:"imgToUse";s:0:"";s:9:"isAutoURL";s:1:"A";s:8:"urlToUse";s:0:"";s:8:"isPosted";s:1:"1";s:4:"pgID";s:33:"1428116197465709_1891972444413413";s:7:"postURL";s:61:"http://www.facebook.com/msftplayground/posts/1891972444413413";s:5:"pDate";s:19:"2017-05-17
    15:42:07";}}";
  snapLI: s:441:"a:1:{i:0;a:11:{s:2:"do";s:1:"1";s:9:"msgFormat";s:41:"New post has
    been published on %SITENAME%";s:8:"postType";s:1:"A";s:9:"isAutoImg";s:1:"A";s:8:"imgToUse";s:0:"";s:9:"isAutoURL";s:1:"A";s:8:"urlToUse";s:0:"";s:8:"isPosted";s:1:"1";s:4:"pgID";s:19:"6270634294050463744";s:7:"postURL";s:104:"https://www.linkedin.com/updates?discuss=&scope=22692038&stype=M&topic=6270634294050463744&type=U&a=FGSd";s:5:"pDate";s:19:"2017-05-17
    15:41:58";}}";
  snapTW: s:379:"a:1:{i:0;a:11:{s:2:"do";s:1:"1";s:9:"msgFormat";s:25:"%TITLE% - %URL%
    - %HTAGS%";s:8:"attchImg";s:1:"0";s:9:"isAutoImg";s:1:"A";s:8:"imgToUse";s:0:"";s:9:"isAutoURL";s:1:"A";s:8:"urlToUse";s:0:"";s:8:"isPosted";s:1:"1";s:4:"pgID";s:18:"864868574585909248";s:7:"postURL";s:60:"https://twitter.com/maikvandergaag/status/864868574585909248";s:5:"pDate";s:19:"2017-05-17
    15:41:51";}}";
  _oembed_b4acb7614547bffc4d48d9a200502a53: "{{unknown}}"
  medium_post: O:11:"Medium_Post":11:{s:16:"author_image_url";N;s:10:"author_url";N;s:11:"byline_name";N;s:12:"byline_email";N;s:10:"cross_link";N;s:2:"id";N;s:21:"follower_notification";N;s:7:"license";N;s:14:"publication_id";N;s:6:"status";N;s:3:"url";N;}
  _wds_opengraph: a:3:{s:5:"title";s:0:"";s:11:"description";s:0:"";s:6:"images";a:1:{i:0;s:0:"";}}
  _wds_twitter: a:3:{s:5:"title";s:0:"";s:11:"description";s:0:"";s:6:"images";a:1:{i:0;s:0:"";}}
  _wds_focus-keywords: API
  _wds_title: ''
  _wds_metadesc: ''
  _wds_meta-robots-adv: ''
  _wds_meta-robots-nofollow: ''
  _wds_canonical: ''
author:
  login: maik@familie-vandergaag.nl
  email: maik@familie-vandergaag.nl
  display_name: Maik van der Gaag
  first_name: Maik
  last_name: van der Gaag
permalink: "/2017/05/part-3-console-application-call-api/"
---
<p>This post is the third and last in a series of three posts and will help you with the creation of identity pass-through authentication from a client application to a API and then to an Azure SQL Database. In this post we will create a console application to query the API published in Azure.</p>
<p>Previous Posts:</p>
<ul>
<li><a href="https://msftplayground.com/2017/04/part-1-azure-sql-database-with-azure-active-directory-authentication" target="_blank" rel="noopener noreferrer">Part 1 – Azure SQL Database with Azure Active Directory Authentication</a></li>
<li><a href="https://msftplayground.com/2017/05/part-2-azure-api-application-to-query-the-azure-sql-database" target="_blank" rel="noopener noreferrer">Part 2 – Azure API Application to query the Azure SQL Database</a></li>
</ul>
<h2>Add new Application to Azure Active Directory</h2>
<p>In order to call our API we need to have a registered application within Azure Active Directory that has delegated permissions for the API application.</p>
<ol>
<li>Navigate to the Azure Portal (<a href="https://portal.azure.com/)">https://portal.azure.com/)</a></li>
<li>Open the “Azure Active Directory” blade.</li>
<li>In the blade click on “App Registrations”.</li>
<li>In the “App Registrations” blade click on “New application registration”.</li>
<li>Fill in a Name (like ConsoleApplication), Application Type: Native and Redirect Url: https://localhost. With everything filled in click on “Create”.</li>
</ol>
<p><a href="https://msftplayground.com/wp-content/uploads/2017/04/clip_image008.jpg"><img style="background-image: none; padding-top: 0px; padding-left: 0px; display: inline; padding-right: 0px; border-width: 0px;" title="Add Application" src="{{ site.baseurl }}/assets/archive/2017/05/clip_image008_thumb.jpg" alt="Add Application" width="240" height="212" border="0" /></a></p>
<ol start="6">
<li>With the application registration created click on the registered application in the application list.</li>
<li>In this window copy the ClientId of the application and click on “Required permissions”.</li>
</ol>
<p><a href="https://msftplayground.com/wp-content/uploads/2017/04/clip_image010.png"><img style="background-image: none; padding-top: 0px; padding-left: 0px; display: inline; padding-right: 0px; border-width: 0px;" title="Console Application Permissions" src="{{ site.baseurl }}/assets/archive/2017/05/clip_image010_thumb.png" alt="Console Application Permissions" width="1081" height="275" border="0" /></a></p>
<ol start="8">
<li>Click “Add” in the Required permissions blade to give the console application delegated permissions on the API we created.</li>
<li>In the “Select an API” search for your created API application and select it.</li>
<li>The permission step will open, make sure you select your application under “Delegated Permissions” and click “Select”.</li>
<li>In the steps blade click “Done”.</li>
</ol>
<h2>Create console application</h2>
<ol>
<li>Open Visual Studio and create a new Console Application.</li>
<li>Open the NuGet Package manager and add the following package:
<ul>
<li>Microsoft.IdentityModel.Clients.ActiveDirectory – <strong>Version: 2.22.302111727</strong></li>
</ul>
</li>
</ol>
<p><em><strong>Note: </strong>Make sure you install version: 2.22.302111727. This version contains the option to prompt for user credentials.</em></p>
<h2>Client authentication with authentication prompt</h2>
<ol>
<li>In the “Program.cs” file add the below methods.</li>
</ol>
<pre class="brush: csharp;">private static void TestApi(string url) {

    var authResult = GetToken();
    string token = authResult.AccessToken;
    if (token != null) {

        HttpClient client = new HttpClient();
        client.DefaultRequestHeaders.Authorization = new AuthenticationHeaderValue("Bearer", token);

        var response = client.GetAsync(new Uri(url));

        string content = response.Result.Content.ReadAsStringAsync().Result;
        Console.WriteLine(content);
    }
}

private static AuthenticationResult GetToken() {

    string aadInstance = "https://login.windows.net/{0}";
    string ResourceId = ConfigurationManager.AppSettings["ResourceId"];
    string tenantId = ConfigurationManager.AppSettings["TenantId"];
    string clientId = ConfigurationManager.AppSettings["ClientId"];
    string replyAddress = ConfigurationManager.AppSettings["ReplyAddressConfigured"];
    AuthenticationContext authenticationContext =
      new AuthenticationContext(string.Format(aadInstance, tenantId));

    AuthenticationResult authenticationResult = authenticationContext.AcquireToken(ResourceId, clientId, new Uri(replyAddress), PromptBehavior.RefreshSession);

    return authenticationResult;
}

</pre>
<p>The methods will call the API with the URL as specified in the “url” parameter but also retrieve a token for the user that logs in to the prompt. The&nbsp;“GetToken” method makes sure this prompt is shown by the "PromptBehavior" enumeration.</p>
<ol start="2">
<li>With the methods in the “Program.cs” file we need to adjust the main method.</li>
</ol>
<pre class="brush: csharp;">static void Main(string[] args) {

    string url = ConfigurationManager.AppSettings["Url"];

    if (string.IsNullOrEmpty(url)) {
        Console.WriteLine("Please fill in your URL:");
        url = Console.ReadLine();
    }

    Console.WriteLine("Calling url: " + url);

    TestApi(url);
    Console.WriteLine("Done processing, press any key to close....");
    Console.ReadKey();
}

</pre>
<ol start="3">
<li>As you may have seen in the previous methods we will save the settings in&nbsp;the configuration file. Open the file and add those settings.</li>
</ol>
<pre class="brush: xml;">&lt;appSettings&gt;
  &lt;add key="TenantId" value="[TenantId]"/&gt;
  &lt;add key="ClientId" value="[ClientId]"/&gt;
  &lt;add key="ResourceId" value="[ResourceId]" /&gt;
  &lt;add key="ReplyAddressConfigured" value="[ReplyUrl]"/&gt;
  &lt;add key="Url" value="[API Url]"/&gt;
&lt;/appSettings&gt;

</pre>
<h2>Test Application</h2>
<p>With everything in place you can test the application and see that the identity&nbsp;moving&nbsp;trough from the Client Application to the API Application and then to Azure SQL Server.</p>
<p>&nbsp;</p>
<p>Complete source code can be downloaded from GitHub:</p>
<p><a href="https://github.com/MaikvanderGaag/PassThroughIdentity" target="_blank" rel="noopener noreferrer">https://github.com/MaikvanderGaag/PassThroughIdentity</a></p>
<p>&nbsp;</p>
