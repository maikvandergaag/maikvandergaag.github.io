---
layout: post
title: Trace listeners (Logging) with Application Insights
date: 2017-02-27 18:32:23.000000000 +01:00
type: post
parent_id: '0'
published: true
password: ''
status: publish
categories:
- DevOps
tags:
- Application Insights
- Azure
- Logging
- Monitoring
- Trace
meta:
  yuzo_related_post_metabox: a:1:{s:21:"yuzo_disabled_related";N;}
  _edit_last: '1'
  _yoast_wpseo_focuskw_text_input: Application Insights
  _yoast_wpseo_focuskw: Application Insights
  _yoast_wpseo_linkdex: '80'
  _yoast_wpseo_content_score: '60'
  _yoast_wpseo_primary_category: ''
  _yoast_wpseo_metadesc: Monitoring and logging needs to be present in every application.
    This can be done by making use of System.Diagnostics.Trace and Application Insights.
  snap_isAutoPosted: '1'
  _wpas_done_all: '1'
  _jetpack_dont_email_post_to_subs: '1'
  _snap_forceSURL: '1'
  snap_MYURL: ''
  snapEdIT: '1'
  snapTW: s:379:"a:1:{i:0;a:11:{s:2:"do";s:1:"1";s:9:"msgFormat";s:25:"%TITLE% - %URL%
    - %HTAGS%";s:8:"attchImg";s:1:"0";s:9:"isAutoImg";s:1:"A";s:8:"imgToUse";s:0:"";s:9:"isAutoURL";s:1:"A";s:8:"urlToUse";s:0:"";s:8:"isPosted";s:1:"1";s:4:"pgID";s:18:"838607567433641985";s:7:"postURL";s:60:"https://twitter.com/maikvandergaag/status/838607567433641985";s:5:"pDate";s:19:"2017-03-06
    04:29:59";}}";
  snapLI: s:441:"a:1:{i:0;a:11:{s:2:"do";s:1:"1";s:9:"msgFormat";s:41:"New post has
    been published on %SITENAME%";s:8:"postType";s:1:"A";s:9:"isAutoImg";s:1:"A";s:8:"imgToUse";s:0:"";s:9:"isAutoURL";s:1:"A";s:8:"urlToUse";s:0:"";s:8:"isPosted";s:1:"1";s:4:"pgID";s:19:"6244373317340528640";s:7:"postURL";s:104:"https://www.linkedin.com/updates?discuss=&scope=22692038&stype=M&topic=6244373317340528640&type=U&a=VQtB";s:5:"pDate";s:19:"2017-03-06
    04:30:13";}}";
  snapFB: s:421:"a:1:{i:0;a:11:{s:2:"do";s:1:"1";s:9:"msgFormat";s:51:"New post (%TITLE%)
    has been published on %SITENAME%";s:8:"postType";s:1:"A";s:9:"isAutoImg";s:1:"A";s:8:"imgToUse";s:0:"";s:9:"isAutoURL";s:1:"A";s:8:"urlToUse";s:0:"";s:8:"isPosted";s:1:"1";s:4:"pgID";s:33:"1428116197465709_1853150964962228";s:7:"postURL";s:61:"http://www.facebook.com/msftplayground/posts/1853150964962228";s:5:"pDate";s:19:"2017-03-06
    04:30:21";}}";
  _oembed_b4acb7614547bffc4d48d9a200502a53: "{{unknown}}"
  medium_post: O:11:"Medium_Post":11:{s:16:"author_image_url";N;s:10:"author_url";N;s:11:"byline_name";N;s:12:"byline_email";N;s:10:"cross_link";N;s:2:"id";N;s:21:"follower_notification";N;s:7:"license";N;s:14:"publication_id";N;s:6:"status";N;s:3:"url";N;}
  _jetpack_related_posts_cache: a:1:{s:32:"8f6677c9d6b0f903e98ad32ec61f8deb";a:2:{s:7:"expires";i:1576667874;s:7:"payload";a:0:{}}}
  _wds_opengraph: a:3:{s:5:"title";s:0:"";s:11:"description";s:0:"";s:6:"images";a:1:{i:0;s:0:"";}}
  _wds_twitter: a:3:{s:5:"title";s:0:"";s:11:"description";s:0:"";s:6:"images";a:1:{i:0;s:0:"";}}
  _wds_focus-keywords: Application Insights
  _wds_title: ''
  _wds_metadesc: Monitoring and logging needs to be present in every application.
    This can be done by making use of System.Diagnostics.Trace and Application Insights.
  _wds_meta-robots-adv: ''
  _wds_meta-robots-nofollow: ''
  _wds_canonical: ''
author:
  login: maik@familie-vandergaag.nl
  email: maik@familie-vandergaag.nl
  display_name: Maik van der Gaag
  first_name: Maik
  last_name: van der Gaag
permalink: "/2017/02/trace-listeners-logging-azure-application-insights/"
---
<p>For every application that is build a logging framework needs to be present. Tracing and Application are framework that can be used in almost every situation.</p>
<p><strong>Application Insights</strong> is an extensible Application Performance Management (APM) service for web developers on multiple platforms. It can be used to monitor your live web application. It can automatically detect performance anomalies and includes powerful analytics tools to help you diagnose issues and to understand what users actually do with your app.</p>
<p><strong>Trace listeners</strong> (Tracing) on the other end are objects that get tracing information from the trace class and output the data to a medium that is configured. For instance you can write trace information to a UI, file or a windows event log.</p>
<p>Trace information can be send to Application Insights by making use of the Application Insights trace listener.</p>
<h2>Custom Tracing class</h2>
<p>Write a custom tracing class for your application. This class can be a static class because we do not want to initiate the class and it needs to be constructed only once. In the class methods need to be created for every event severity.</p>
<pre class="brush: csharp;">public static class AppTrace {
    private static TraceSource traceSource { get; set; }

    static AppTrace() {
        traceSource = new TraceSource("TraceLogging");
    }

    public static void Verbose(string message, int id = 16, [CallerMemberName]string memberName = "", [CallerFilePath] string filePath = "", [CallerLineNumber]int lineNumber = 0) {
        traceSource.TraceEvent(TraceEventType.Verbose, id, Format(message, memberName, filePath, lineNumber));
    }

    public static void Error(string message, int id = 2, [CallerMemberName]string memberName = "", [CallerFilePath] string filePath = "", [CallerLineNumber]int lineNumber = 0) {
        traceSource.TraceEvent(TraceEventType.Error, id, Format(message, memberName, filePath, lineNumber));
    }

    public static void Information(string message, int id = 8, [CallerMemberName]string memberName = "", [CallerFilePath] string filePath = "", [CallerLineNumber]int lineNumber = 0)
        traceSource.TraceEvent(TraceEventType.Information, id, Format(message, memberName, filePath, lineNumber));
    }

    public static void Critical(string message, int id = 1, [CallerMemberName]string memberName = "", [CallerFilePath] string filePath = "", [CallerLineNumber]int lineNumber = 0) {
        traceSource.TraceEvent(TraceEventType.Critical, id, Format(message, memberName, filePath, lineNumber));
    }

    public static void Warning(string message, int id = 4, [CallerMemberName]string memberName = "", [CallerFilePath] string filePath = "", [CallerLineNumber]int lineNumber = 0) {
        traceSource.TraceEvent(TraceEventType.Warning, id, Format(message, memberName, filePath, lineNumber));
    }

    public static void Start(string service, int id = 256, [CallerMemberName]string memberName = "", [CallerFilePath] string filePath = "", [CallerLineNumber]int lineNumber = 0) {
        traceSource.TraceEvent(TraceEventType.Start, id, Format("Starting - " + service, memberName, filePath, lineNumber));
    }

    public static void Stop(string service, int id = 512, [CallerMemberName]string memberName = "", [CallerFilePath] string filePath = "", [CallerLineNumber]int lineNumber = 0) {
        traceSource.TraceEvent(TraceEventType.Stop, id, Format("Stoping - " + service, memberName, filePath, lineNumber));
    }

    private static string Format(string message, string memberName, string filePath, int lineNumber) {
        return $"Message: {message}, MemberName: {memberName}, FilePath: {filePath}, LineNumber: {lineNumber}";
    }
}

</pre>
<p>In the constructor the source name is configured this makes it possible to bind the trace listeners within the application configuration.</p>
<h2>Application Insight trace listener</h2>
<p>For sending trace information to Application Insights a reference needs need to be added to the project by adding "Microsoft.ApplicationInsights.TraceListener" NuGet package.</p>
<h3>From the “Package Manager Console”</h3>
<pre class="brush: powershell;">Install-Package Microsoft.ApplicationInsights.TraceListener
</pre>
<h3>From the “Package Manager UI”</h3>
<p><a href="https://msftplayground.com/wp-content/uploads/2017/02/image.png"><img style="background-image: none; padding-top: 0px; padding-left: 0px; display: inline; padding-right: 0px; border-width: 0px;" title="NuGet Package Manager" src="{{ site.baseurl }}/assets/archive/2017/02/image_thumb.png" alt="NuGet Package Manager" width="470" height="315" border="0" /></a></p>
<h2>Configure the trace listener</h2>
<p>To bind trace listeners to the trace source they need to be configured within the web.config or app.config. This can be done by adding the below configuration section within the configuration tag.</p>
<pre class="brush: xml;">&lt;system.diagnostics&gt;
  &lt;sources&gt;
    &lt;source name="TraceLogging" switchName="Verbose"&gt;
      &lt;listeners&gt;
        &lt;add name="appinsights" type="Microsoft.ApplicationInsights.TraceListener.ApplicationInsightsTraceListener, Microsoft.ApplicationInsights.TraceListener"/&gt;
        &lt;add name="console" type="System.Diagnostics.ConsoleTraceListener" /&gt;
      &lt;/listeners&gt;
    &lt;/source&gt;
  &lt;/sources&gt;
&lt;/system.diagnostics&gt;
</pre>
<p>Within our class the trace listeners are referenced by using the source name “TraceLogging”.</p>
<p>Within the configuration of the “Source” the listeners are configured. In the snip-it above it has a listener for Application Insights and for the Console Window. This means that depending on the “TraceLevel” of the message the message will be send to Application Insights and to the Console.</p>
<p>Which messages are send to the listeners depend on the switch. In the "source" tag it is configured by the "swithName" property. The switch is something you would like change when you find a problem within your application.</p>
<h2>Azure</h2>
<p>At the moment it is not possible to change tracing configuration within the Azure Portal that will reflect the above settings. To be able to make this configurable you can add a specific app setting to be able to set the switch in code.</p>
<p>Besides the switch you should also make the Id ("InstrumentationKey") of the Application Insights service configurable.</p>
<h2>Additions to keep it configurable</h2>
<h3>Web.config</h3>
<p>Add an application setting for the instrumentation key and trace switch.</p>
<pre class="brush: xml;">&lt;appSettings&gt;
  &lt;add key="InstrumentationKey" value="[key]"/&gt;
  &lt;add key="TraceSwitch" value="All"/&gt;
&lt;/appSettings&gt;
</pre>
<h3>Trace Class</h3>
<p>To make use of these settings we also need to adjust the constructor of our class. Make the following adjustments to the constructor.</p>
<pre class="brush: csharp;">static AppTrace() {
    traceSource = new TraceSource("TraceLogging");
    traceSource.Switch.Level = (SourceLevels)Enum.Parse(typeof(SourceLevels), ConfigurationManager.AppSettings["TraceSwitch"], true);
    TelemetryConfiguration.Active.InstrumentationKey = ConfigurationManager.AppSettings["InstrumentationKey"];
}</pre>
<h2>Write information to the Trace Log</h2>
<p>With everything in place it is easy to write monitoring information to any source of your choosing, and depending on the level specified in the settings information will be send to the log.</p>
<pre class="brush: csharp;">class Program {
    static void Main(string[] args) {
        AppTrace.Verbose("Test Verbose");
        AppTrace.Error("Test Error");
        AppTrace.Warning("Test Warning");
        AppTrace.Information("Test Information");
        AppTrace.Critical("Test Critical");

        Console.ReadKey();
    }
}
</pre>
<p>Starting this console application will show messages within in the console and Application Insights:</p>
<p><strong>Console Output</strong></p>
<p><a href="https://msftplayground.com/wp-content/uploads/2017/02/image-1.png"><img style="background-image: none; padding-top: 0px; padding-left: 0px; display: inline; padding-right: 0px; border: 0px;" title="Console Output" src="{{ site.baseurl }}/assets/archive/2017/02/image_thumb-1.png" alt="Console Output" width="420" height="220" border="0" /></a></p>
<p><strong>Application Insights Output</strong></p>
<p><a href="https://msftplayground.com/wp-content/uploads/2017/02/image-2.png"><img style="background-image: none; padding-top: 0px; padding-left: 0px; display: inline; padding-right: 0px; border: 0px;" title="Application Insights Trace Output" src="{{ site.baseurl }}/assets/archive/2017/02/image_thumb-2.png" alt="Application Insights Trace Output" width="476" height="294" border="0" /></a></p>
<p>&nbsp;</p>
<p>As we change the “TraceSwith” setting to for example “Critical” you will see within the console window that less information is send by the trace source.</p>
<p><a href="https://msftplayground.com/wp-content/uploads/2017/02/image-3.png"><img style="background-image: none; padding-top: 0px; padding-left: 0px; display: inline; padding-right: 0px; border: 0px;" title="Trace Output Critical" src="{{ site.baseurl }}/assets/archive/2017/02/image_thumb-3.png" alt="Trace Output Critical" width="458" height="240" border="0" /></a></p>
<div class="post">
<div class="body">
<div id="3072c427-6a85-431f-a22a-d156ceca7b23" class="postBody" style="margin: 4px 0px 0px; border-width: 0px; padding: 0px;" contenteditable="true">
<p>Sample code is placed on a public repository within GitHub:</p>
<ul>
<li><a title="https://github.com/MaikvanderGaag/MSFT-TracingSample" href="https://github.com/MaikvanderGaag/MSFT-TracingSample">https://github.com/MaikvanderGaag/MSFT-TracingSample</a></li>
</ul>
</div>
</div>
</div>
