---
layout: post
title: On-demand Azure Policy Scan
date: 2019-06-20 11:30:39.000000000 +02:00
type: post
parent_id: '0'
published: true
password: ''
status: publish
categories:
- Azure
- DevOps
tags:
- Azure
- Azure Policy
- DevOps
meta:
  medium_post: O:11:"Medium_Post":11:{s:16:"author_image_url";N;s:10:"author_url";N;s:11:"byline_name";N;s:12:"byline_email";N;s:10:"cross_link";s:3:"yes";s:2:"id";N;s:21:"follower_notification";s:3:"yes";s:7:"license";s:19:"all-rights-reserved";s:14:"publication_id";s:2:"-1";s:6:"status";s:6:"public";s:3:"url";N;}
  _oembed_5e2aa3791f334d2884d596312e422144: "{{unknown}}"
  _thumbnail_id: '5639'
  _edit_last: '3'
  slide_template: default
  _yoast_wpseo_primary_category: '323'
  _dt_sidebar_position: right
  _dt_sidebar_widgetarea_id: sidebar_1
  _dt_sidebar_hide_on_mobile: '0'
  _dt_footer_show: '1'
  _dt_footer_widgetarea_id: sidebar_2
  _dt_footer_hide_on_mobile: '0'
  _dt_header_title: enabled
  _dt_header_background: normal
  _dt_header_background_below_slideshow: disabled
  _dt_header_transparent_bg_color_scheme: light
  _dt_header_transparent_top_bar_bg_color: "#ffffff"
  _dt_header_transparent_top_bar_bg_opacity: '25'
  _dt_header_transparent_bg_color: "#000000"
  _dt_header_transparent_bg_opacity: '50'
  _dt_header_disabled_background: normal
  _dt_header_disabled_transparent_bg_color_scheme: light
  _dt_header_disabled_transparent_top_bar_bg_color: "#ffffff"
  _dt_header_disabled_transparent_top_bar_bg_opacity: '25'
  _dt_header_disabled_transparent_bg_color: "#000000"
  _dt_header_disabled_transparent_bg_opacity: '50'
  _dt_page_overrides_top_margin: ''
  _dt_page_overrides_bottom_margin: ''
  _dt_post_options_back_button: ''
  _dt_post_options_hide_thumbnail: '0'
  _dt_post_options_related_mode: same
  _dt_post_options_preview: normal
  _yoast_wpseo_focuskw: Azure Policy
  _yoast_wpseo_metadesc: With Azure Policy you can govern and monitor your Azure Subscription.
    The platform checks the subscription but when and can I trigger it?
  _yoast_wpseo_linkdex: '71'
  _yoast_wpseo_content_score: '30'
  _snap_forceSURL: '1'
  snap_MYURL: ''
  snapEdIT: '1'
  _nxs_slinks: a:1:{s:32:"c7fef6ee5f38096c87049d05a0b0c65e";s:21:"http://bit.ly/2WW2iq4";}
  snap_MYSURL: a:3:{s:1:"s";s:21:"http://bit.ly/2WW2iq4";s:1:"t";s:63:"https://msftplayground.com/2019/06/on-demand-azure-policy-scan/";s:1:"r";s:1:"B";}
  snapLI: s:463:"a:1:{i:0;a:12:{s:2:"do";s:1:"1";s:9:"msgFormat";s:71:"New post (%TITLE%)
    has been published on %SITENAME% - %HTAGS% - %HCATS%";s:8:"postType";s:1:"A";s:9:"isAutoImg";s:1:"A";s:8:"imgToUse";s:0:"";s:9:"isAutoURL";s:1:"A";s:8:"urlToUse";s:0:"";s:4:"doLI";i:0;s:8:"isPosted";s:1:"1";s:4:"pgID";s:32:"urn:li:share:6547420287900672000";s:7:"postURL";s:69:"https://www.linkedin.com/feed/update/urn:li:share:6547420287900672000";s:5:"pDate";s:19:"2019-06-20
    10:30:42";}}";
  snap_isAutoPosted: '1561026642'
  _snapPHST: a:2:{s:2:"li";a:1:{i:0;a:1:{i:0;a:4:{s:1:"l";s:69:"https://www.linkedin.com/feed/update/urn:li:share:6547420287900672000";s:2:"id";s:32:"urn:li:share:6547420287900672000";s:1:"d";s:19:"2019-06-20
    10:30:42";s:1:"w";s:1:"s";}}}s:2:"tw";a:1:{i:0;a:1:{i:0;a:4:{s:1:"l";s:61:"https://twitter.com/maikvandergaag/status/1141654600543608833";s:2:"id";s:19:"1141654600543608833";s:1:"d";s:19:"2019-06-20
    10:30:42";s:1:"w";s:1:"s";}}}}
  snapTW: s:403:"a:1:{i:0;a:12:{s:2:"do";s:1:"1";s:9:"msgFormat";s:32:"%TITLE% - %HCATS%
    %HTAGS%  %URL%";s:8:"attchImg";s:1:"0";s:9:"isAutoImg";s:1:"A";s:8:"imgToUse";s:0:"";s:9:"isAutoURL";s:1:"A";s:8:"urlToUse";s:0:"";s:4:"doTW";i:0;s:8:"isPosted";s:1:"1";s:4:"pgID";s:19:"1141654600543608833";s:7:"postURL";s:61:"https://twitter.com/maikvandergaag/status/1141654600543608833";s:5:"pDate";s:19:"2019-06-20
    10:30:42";}}";
  _oembed_8725cd87e0507719408e8c206c63df9b: "{{unknown}}"
  _oembed_4cca7852d55493d1ae772631ba570a61: "{{unknown}}"
  _oembed_3624dadd802374c57d6d9d86c8cb343e: "{{unknown}}"
  _jetpack_related_posts_cache: a:1:{s:32:"8f6677c9d6b0f903e98ad32ec61f8deb";a:2:{s:7:"expires";i:1576667045;s:7:"payload";a:0:{}}}
  _wds_opengraph: a:3:{s:5:"title";s:0:"";s:11:"description";s:0:"";s:6:"images";a:1:{i:0;s:0:"";}}
  _wds_twitter: a:3:{s:5:"title";s:0:"";s:11:"description";s:0:"";s:6:"images";a:1:{i:0;s:0:"";}}
  _wds_focus-keywords: Azure Policy
  _wds_title: ''
  _wds_metadesc: With Azure Policy you can govern and monitor your Azure Subscription.
    The platform checks the subscription but when and can I trigger it?
  _wds_meta-robots-adv: ''
  _wds_meta-robots-nofollow: ''
  _wds_canonical: ''
author:
  login: maik@familie-vandergaag.nl
  email: maik@familie-vandergaag.nl
  display_name: Maik van der Gaag
  first_name: Maik
  last_name: van der Gaag
permalink: "/2019/06/on-demand-azure-policy-scan/"
---
<p><!-- wp:paragraph --></p>
<p>When moving to a DevOps way of working it is important to have a good set of rules on how to work with software and infrastructure.  When looking into Azure this rule set can be converted into Azure Policy and policies rules. </p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:paragraph --></p>
<p>Azure policies enforce rules and effects over the resources, so those resources stay compliant with your standards and service level agreements. Azure Policy meets this need by evaluating your resources for non-compliance with assigned policies. For example, you can have a policy to allow only a certain location in your platform. Once this policy is implemented, new and existing resources are evaluated for compliance. For more information look at the documentation <a rel="noreferrer noopener" aria-label="here (opens in a new tab)" href="https://docs.microsoft.com/en-us/azure/governance/policy/overview" target="_blank">here</a>.</p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:paragraph --></p>
<p>As mentioned policies govern your Azure Subscription. The compliance of the platform is checked via the Portal or command line scripting. But when does the platform check the compliance of the resources?</p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:heading --></p>
<h2>Compliance check</h2>
<p><!-- /wp:heading --></p>
<p><!-- wp:paragraph --></p>
<p>The evaluation of the policies take place on the following events:</p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:list --></p>
<ul>
<li>New policy assignment. ( ~30 minutes).</li>
<li>Updated assignment of a existing policy. (~ 30 minutes)</li>
<li>Deployment of a resources. (~15 minutes)</li>
<li>Every 24 hours</li>
<li>Update of the resource provider </li>
<li>On-demand (~3 minutes)</li>
</ul>
<p><!-- /wp:list --></p>
<p><!-- wp:paragraph --></p>
<p>As described on the above list it can take a while for the policies are checked. If you want the fasted possible feedback you will need to do an on-demand scan.</p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:heading --></p>
<h2>On-demand</h2>
<p><!-- /wp:heading --></p>
<p><!-- wp:paragraph --></p>
<p>Via the rest API a on-demand scan of the policies can be triggered. When using this method information about the compliance will be available in around 3 minutes. Triggering can be done on resource group or on a Azure subscription.</p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:quote --></p>
<blockquote class="wp-block-quote"><p><em>https://management.azure.com/subscriptions/{subscriptionId}/providers/Microsoft.PolicyInsights/policyStates/latest/triggerEvaluation?api-version=2018-07-01-preview</em></p>
<p><cite>Subscription (Post)</cite></p></blockquote>
<p><!-- /wp:quote --></p>
<p><!-- wp:quote --></p>
<blockquote class="wp-block-quote"><p>https://management.azure.com/subscriptions/{subscriptionId}/resourceGroups/{ResourceGroup}/providers/Microsoft.PolicyInsights/policyStates/latest/triggerEvaluation?api-version=2018-07-01-preview</p>
<p><cite>Resource Group (Post)</cite></p></blockquote>
<p><!-- /wp:quote --></p>
<p><!-- wp:heading --></p>
<h2>PowerShell</h2>
<p><!-- /wp:heading --></p>
<p><!-- wp:paragraph --></p>
<p>These API calls can be added in a simple PowerShell script to trigger the evaluation. The below example is a script to trigger the evaluation on every subscription you have access to.</p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:syntaxhighlighter/code {"language":"powershell"} --></p>
<pre class="wp-block-syntaxhighlighter-code">$account = Get-AzContext
if ($null -eq $account.Account) {
    Write-Output("Account Context not found, please login")
    Connect-AzAccount
}

$subscriptions = Get-AzSubscription

foreach($subscription in $subscriptions){
    Set-AzContext -Subscription $subscription

    $SubscriptionId = $subscription.Id

    $azContext = Get-AzContext
    $azProfile = [Microsoft.Azure.Commands.Common.Authentication.Abstractions.AzureRmProfileProvider]::Instance.Profile
    $profileClient = New-Object -TypeName Microsoft.Azure.Commands.ResourceManager.Common.RMProfileClient -ArgumentList ($azProfile)
    $token = $profileClient.AcquireAccessToken($azContext.Subscription.TenantId)

    $authHeader = @{
        'Content-Type'='application/json'
        'Authorization'='Bearer ' + $token.AccessToken
    }

    $restUri = "https://management.azure.com/subscriptions/$SubscriptionId/providers/Microsoft.PolicyInsights/policyStates/latest/triggerEvaluation?api-version=2018-07-01-preview"

    # Invoke the REST API
    $response = Invoke-webrequest -Uri $restUri -Method POST -Headers $authHeader

    # View the response object (as JSON)
    $response
}</pre>
<p><!-- /wp:syntaxhighlighter/code --></p>
